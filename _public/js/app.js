"use strict";var App=angular.module("app",["ngCookies","ngResource","ngRoute","ngAnimate","app.wallet","app.global","app.directives","app.filters","app.services","partials"]);App.Wallet=angular.module("app.wallet",[]),App.Global=angular.module("app.global",[]),App.config(["$routeProvider","$locationProvider",function(e,t){return e.when("/dashboard",{controller:"DashboardCtrl",templateUrl:"/partials/dashboard.html"}).when("/send",{controller:"SendCtrl",templateUrl:"/partials/send.html"}).when("/receive",{controller:"ReceiveCtrl",templateUrl:"/partials/receive.html"}).when("/transactions",{controller:"TransactionsCtrl",templateUrl:"/partials/transactions.html"}).when("/addresses",{controller:"AddressesCtrl",templateUrl:"/partials/addresses.html"}).when("/initialize",{controller:"InitializeCtrl",templateUrl:"/partials/initialize.html"}).otherwise({redirectTo:"/dashboard"}),t.html5Mode(!1)}]),App.run(["$rootScope","$route","$location","daemonManager",function(e,t,n,o){var i=o.getHandler();e.$on("$routeChangeStart",function(e,t){void 0!=t&&void 0!=t.$$route&&(i.isRunning()||i.isInitialized()||n.path("/initialize"))})}]);var DataStore,createDocumentStore,createRelationalStore,createSimpleStore;DataStore="undefined"!=typeof exports&&null!==exports&&exports||(this.DataStore={}),DataStore.create=function(e){switch(e){case"simple":return createSimpleStore();case"relational":return createRelationalStore();case"document":return createDocumentStore();default:return void 0}},createSimpleStore=function(){return{get:function(e){return JSON.parse(localStorage.getItem(JSON.stringify(e)))},set:function(e,t){return localStorage.setItem(JSON.stringify(e),JSON.stringify(t))},"delete":function(e){return localStorage.removeItem(JSON.stringify(e))},count:function(){return localStorage.length},clear:function(){return localStorage.clear()}}},createRelationalStore=function(){var e,t;return e=openDatabase("nwsqldb","1.0","embedded sql database",268435456),t={run:function(t,n){return e.transaction(function(e){return e.executeSql(t,[],function(e,t){var o;return"function"==typeof n?n(function(){var e,n,i;for(i=[],o=e=0,n=t.rows.length;n>=0?n>e:e>n;o=n>=0?++e:--e)i.push(t.rows.item(o));return i}()):void 0})})}}},createDocumentStore=function(){var e,t,n,o;try{return e=require("nedb"),t=require("nw.gui").App.dataPath+"/nedb",o={collection:function(t){return new e({filename:"/"+t,autoload:!0})}}}catch(i){return n=i,console.error("MODULE_NOT_FOUND"===n.code?"NeDB not found. Try `npm install nedb --save` inside of `/app/assets`.":n)}},angular.module("app.directives",["app.services"]).directive("appVersion",["version",function(e){return function(t,n){return n.text(e)}}]),angular.module("app.filters",[]).filter("interpolate",["version",function(e){return function(t){return String(t).replace(/\%VERSION\%/gm,e)}}]),App.Global.controller("AppCtrl",["$scope","$location","$resource","$rootScope","daemonManager","wallet",function(e,t,n,o,i,r){return e.wallet=r,e.daemon={running:!1},e.daemon.running=i.getHandler().isRunning(),e.$on("daemon.initialized",function(t){e.daemon.running=t}),e.$location=t,e.$watch("$location.path()",function(t){return e.activeNavId=t||"/"}),e.getClass=function(t){return e.activeNavId.substring(0,t.length)===t?"active":""}}]),App.Global.controller("InitializeCtrl",["$scope","$location","$resource","$rootScope","daemonManager","wallet",function(e,t,n,o,i,r){var a=i.getHandler();e.loadingStatus="Loading...",e.displayError=function(t,n){e.loadingStatus=t,e.loadingStatusError=n},e.initialize=function(){r.initialize();var n=a.start();n===!1?e.displayError("Uh Oh!",a.error):n.then(function(n){n?t.path("/dashboard"):e.displayError("Uh Oh!",a.error)})},e.initialize()}]),angular.module("app.services",[]).factory("version",function(){return"0.1"}),App.Wallet.controller("AddressesCtrl",["$scope",function(e){return e}]),App.Wallet.factory("wallet",["$q","$timeout","$rootScope","daemonManager",function(e,t,n,o){var i=o.getClient(),r=function(){this.info={version:"",protocolversion:"",walletversion:"",balance:0,blocks:0,timeoffset:0,connections:0,proxy:"",difficulty:0,testnet:!1,keypoololdest:0,keypoolsize:0,paytxfee:0,mininput:0,errors:""},this.accounts=[]};return r.prototype={send:function(e){i.exec("settxfee",e.fee,function(t,n){console.log(t),console.log(n),(n||"true"==n)&&i.exec("sendtoaddress",e.address,parseFloat(e.amount),e.payerComment,e.payeeComment,function(e,t){console.log(e),console.log(t)})})},updateInfo:function(){var e=this;i.exec("getinfo",function(t,o){null==t&&(e.info=o,n.$apply())})},updateAccounts:function(){var e=require("async"),t=this;i.exec("listaccounts",function(o,r){if(null==o){var a=[];for(var l in r)r.hasOwnProperty(l)&&!function(o){e.series({one:function(e){var t={label:o,balance:r[o],address:""};a.push(t),i.exec("getaccountaddress",t.label,function(n,o){null!=n?(console.log(n),e(!1)):(t.address=o,e(!0))})}},function(){t.accounts=a,n.$apply()})}(l)}})},initialize:function(){var e=this;n.$on("daemon.initialization.success",function(){e.updateInfo(),e.updateAccounts()}),n.$on("daemon.notifications.block",function(){e.updateInfo(),e.updateAccounts()})}},new r}]),App.Wallet.DaemonHandler=function(){function e(e,t,n){this.$q=e,this.$timeout=t,this.$rootScope=n,this.node={os:require("os"),fs:require("fs"),gui:require("nw.gui"),childProcess:require("child_process")},this.daemonMap={linux:{x32:"daemons/reddcoind-linux32",x64:"daemons/reddcoind-linux64","default":"daemons/reddcoind-linux32"},win32:{x32:"daemons/reddcoind-win32","default":"daemons/reddcoind-win32"},darwin:{x32:"daemons/reddcoind-mac32",x64:"daemons/reddcoind-mac32","default":"daemons/reddcoind-mac-32"}},this.daemon=null,this.daemonFilePath=null,this.initialized=!1,this.running=!1,this.deferred=this.$q.defer(),this.error=null,this.lastNotification=(new Date).getTime()}return e.prototype={hasValidDaemon:function(){var e=(this.node.os.arch(),this.node.os.platform());return void 0!==this.daemonMap[e]},initializeFilePath:function(){var e=this.node.os.arch(),t=this.node.os.platform();void 0!==this.daemonMap[t]&&(this.daemonFilePath=void 0==this.daemonMap[t][e]?this.daemonMap[t]["default"]:this.daemonMap[t][e])},isWindows:function(){return"win32"===this.node.os.platform()},start:function(){if(this.isInitialized())return console.log("Cannot start the daemon handler again without resetting first."),this.deferred;if(!this.hasValidDaemon())return this.error="This operating system does not support running the Reddcoin daemon.",this.deferred.reject(!1),this.$rootScope.$broadcast("daemon.initialized",!1),!1;if(this.initializeFilePath(),!this.node.fs.existsSync(this.daemonFilePath))return this.error="Cannot find the daemon for this operating system ("+this.node.os.platform()+" "+this.node.os.arch()+").",this.deferred.reject(!1),this.$rootScope.$broadcast("daemon.initialized",!1),!1;var e=this.node.gui.Window.get();this.isWindows()||this.node.childProcess.exec("chmod 777 "+this.daemonFilePath),this.daemon=this.node.childProcess.spawn(this.daemonFilePath,['-alertnotify=echo "ALERT:%s"','-blocknotify=echo "BLOCK:%s"','-walletnotify=echo "WALLET:%s"']),setInterval(function(){t.$rootScope.$emit("daemon.notifications.block")},3e4),this.daemon.stdout.on("data",function(){t.$rootScope.$emit("daemon.notifications.block")}),this.daemon.stderr.on("data",function(){e.close()}),this.daemon.on("close",function(){console.log("Daemon child process has ended...")}),e.on("close",function(){t.daemon.kill(),this.close(!0)});var t=this;return this.$timeout(function(){return t.running=!0,t.initialized=!0,t.deferred.resolve(!0),t.$rootScope.$broadcast("daemon.initialized",!0),t.$rootScope.$broadcast("daemon.initialization.success"),!0},1e3),this.deferred.promise},isRunning:function(){return this.running},isInitialized:function(){return this.initialized}},e}(),App.Wallet.factory("daemonManager",["$q","$timeout","$rootScope",function(e,t,n){var o=new App.Wallet.DaemonHandler(e,t,n),i=require("node-reddcoin")({user:"user",pass:"password"});return{getClient:function(){return i},getHandler:function(){return o}}}]),App.Wallet.controller("DashboardCtrl",["$scope","daemonManager","wallet",function(e,t,n){e.wallet=n}]),App.Wallet.controller("ReceiveCtrl",["$scope","daemonManager","wallet",function(e,t,n){e.wallet=n}]),App.Wallet.controller("SendCtrl",["$scope","daemonManager","wallet",function(e,t,n){e.wallet=n,e.send={amount:0,address:"Rer7K4AwRhUYshzzPeamRkC9cV7M6BSz3P",payerComment:"",payeeComment:"",fee:.001},e.confirmSend=function(){n.send(e.send)}}]),App.Wallet.controller("TransactionsCtrl",["$scope",function(e){return e}]);